# Standardized 3D Model File Structure

## Directory Structure

```
public/assets/models/
└── ModelName/
    ├── model_name.glb                    # SOURCE (committed to git)
    ├── glb/                               # BASE OPTIMIZED (gitignored)
    │   └── model_name.glb                 # Decimated + optimized base model
    └── lod/                               # LOD VARIANTS (gitignored)
        ├── model_name.high_fidelity.glb   # 75% of base triangles
        └── model_name.low_fidelity.glb    # 35% of base triangles
```

## File Purposes

### 1. Root Directory (`ModelName/model_name.glb`)

- **Purpose**: Source file, original asset from 3D software
- **Triangle Count**: Any (may be very high)
- **Version Control**: **COMMITTED** to git
- **Used By**: Optimization pipeline as input
- **Example**: `FarmHouse/farm_house_basic_shaded.glb` (499K triangles)

### 2. GLB Subdirectory (`glb/model_name.glb`)

- **Purpose**: Optimized base model loaded by application
- **Triangle Count**: Target range for model type (hero: 40K, prop: 10K, bg: 3K)
- **Version Control**: **GITIGNORED** (regenerated by pipeline)
- **Used By**: Application at runtime (default/close distance)
- **Processing**: Blender decimation → Draco compression → texture optimization
- **Example**: `FarmHouse/glb/farm_house_basic_shaded.glb` (20K triangles)

### 3. LOD Subdirectory (`lod/model_name.{quality}.glb`)

- **Purpose**: Distance-based quality variants
- **Triangle Count**: Percentage of base model
  - `high_fidelity`: 75% of base (medium distance)
  - `low_fidelity`: 35% of base (far distance)
- **Version Control**: **GITIGNORED** (regenerated by pipeline)
- **Used By**: LOD system based on camera distance
- **Processing**: Generated from glb/ base model via meshopt simplify
- **Example**:
  - `FarmHouse/lod/farm_house_basic_shaded.high_fidelity.glb` (15K triangles)
  - `FarmHouse/lod/farm_house_basic_shaded.low_fidelity.glb` (7K triangles)

## LOD System Integration

### How Models Are Loaded

```typescript
// Application code uses LOD-aware path resolution
import { useLODModel } from '@core/hooks/useLODModel';

// Base path points to glb/ subdirectory
const modelPath = useLODModel({
  basePath: '/assets/models/FarmHouse/glb/farm_house_basic_shaded.glb',
  distance: cameraDistance,
});

// LOD system automatically resolves to:
// - distance < 50:  /assets/models/FarmHouse/glb/farm_house_basic_shaded.glb (original)
// - distance 50-100: /assets/models/FarmHouse/lod/farm_house_basic_shaded.high_fidelity.glb
// - distance > 100:  /assets/models/FarmHouse/lod/farm_house_basic_shaded.low_fidelity.glb
```

### Path Resolution Logic

```typescript
// From LODManager
function getLODPath(basePath: string, quality: LODQuality): string {
  if (quality === 'original') {
    return basePath; // Returns glb/model.glb
  }

  // /assets/models/Model/glb/model.glb
  // → /assets/models/Model/lod/model.high_fidelity.glb
  const fileName = basename(basePath, '.glb');
  const modelDir = dirname(dirname(basePath)); // Go up from glb/
  return join(modelDir, 'lod', `${fileName}.${quality}.glb`);
}
```

## Optimization Pipeline Flow

### Current State (Partial Implementation)

```
1. Source Model (root/)
   ↓
2. Blender Decimation → glb/model.glb ✅
   ↓
3. TODO: Generate LOD Variants → lod/*.glb ❌
   ↓
4. TODO: Apply Draco Compression ❌
```

### Target State (Full Pipeline)

```
1. Source: ModelName/model.glb (499K triangles)
   ↓
2. Analyze & Classify (hero/prop/background)
   ↓
3. Blender Decimation
   └→ glb/model.glb (20K triangles)
   ↓
4. Generate LOD Variants from glb/
   ├→ lod/model.high_fidelity.glb (15K triangles, 75%)
   └→ lod/model.low_fidelity.glb (7K triangles, 35%)
   ↓
5. Apply Draco Compression to all variants
   └→ Final compressed files in glb/ and lod/
```

## Commands

### Check Model Structure

```bash
# Verify a model follows the structure
tree public/assets/models/FarmHouse

# Expected output:
# FarmHouse/
# ├── farm_house_basic_shaded.glb        # Source
# ├── glb/
# │   └── farm_house_basic_shaded.glb    # Base optimized
# └── lod/
#     ├── farm_house_basic_shaded.high_fidelity.glb
#     └── farm_house_basic_shaded.low_fidelity.glb
```

### Generate Structure

```bash
# Run optimization pipeline
USE_BLENDER_DECIMATION=true AUTO_DECIMATE_MODELS=true node scripts/optimize.js

# This creates:
# 1. glb/model.glb - Decimated base ✅
# 2. lod/*.glb - TODO: Not yet implemented ❌
```

## Migration Guide

If you have existing models not following this structure:

### Option 1: Move Models to Conform

```bash
cd public/assets/models/ModelName

# If model is in glb/ but should be in root:
mv glb/model.glb ./model.glb  # Move to source location
rm -rf glb/ lod/               # Clear generated dirs

# Re-run optimization
USE_BLENDER_DECIMATION=true AUTO_DECIMATE_MODELS=true node scripts/optimize.js
```

### Option 2: Manually Create Structure

```bash
# If you have a pre-optimized model:
mkdir -p glb lod
cp model.glb glb/model.glb  # Copy as base optimized

# TODO: Generate LOD variants (pipeline integration pending)
```

## Next Steps

To complete the standardized pipeline:

1. **Integrate LOD generation into optimize.js**

   - After Blender decimation creates `glb/model.glb`
   - Generate `lod/model.high_fidelity.glb` (75% ratio)
   - Generate `lod/model.low_fidelity.glb` (35% ratio)

2. **Apply Draco compression to all variants**

   - Compress `glb/model.glb`
   - Compress both LOD variants
   - Use existing optimize-models.js Draco logic

3. **Add manifest tracking**

   - Track source file hash
   - Skip if source unchanged
   - Regenerate all variants if source changes

4. **Update documentation**
   - Document expected triangle counts per LOD level
   - Add visual quality comparison guide
   - Provide troubleshooting for LOD transitions

## Current Status

✅ **Working:**

- Directory structure defined and documented
- Source models in root directory
- Base optimized models save to `glb/` subdirectory
- LOD system expects `lod/` subdirectory for variants

❌ **TODO:**

- Automatic LOD variant generation
- Integration with existing optimize-models.js for Draco
- Manifest-based caching
- Complete end-to-end pipeline

⚠️ **Temporary Workaround:**
Until LOD generation is integrated, models will use the base `glb/model.glb` file for all distances. LOD transitions will be disabled.

## Related Documentation

- [OPTIMIZATION-WORKFLOW.md](./OPTIMIZATION-WORKFLOW.md) - Current optimization commands
- [OPTIMIZATION-SUMMARY.md](../OPTIMIZATION-SUMMARY.md) - Solution overview
- [MODEL-DECIMATION-GUIDE.md](./MODEL-DECIMATION-GUIDE.md) - Quality guidelines
- [3D-ASSET-OPTIMIZATION-GUIDE.md](./3D-ASSET-OPTIMIZATION-GUIDE.md) - Original pipeline docs
